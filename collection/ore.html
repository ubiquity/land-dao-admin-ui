<html>
  <head>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.3.5/dist/web3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="contract.js"></script>

    <script>
      $(async function() {
        function ethEnabled() {
          if (typeof window.ethereum !== 'undefined') {
            window.ethereum.request({ method: 'eth_requestAccounts' });
          } else {
            alert('Install MetaMask and try again');
          }
        }

        if (window.ethereum) {
          window.ethereum.on('accountsChanged', function (accounts) {
            window.location.reload();
          });

          console.log('Metamask enabled');
          web3 = new Web3(window.ethereum);
          let accounts = await web3.eth.getAccounts();

          const ore = new web3.eth.Contract(oreAbi, oreAddress);
          const cartelOreClaim = new web3.eth.Contract(cartelOreClaimAbi, cartelOreClaimAddress);

          let cartelOreClaimEnabled = false;
          try {
            cartelOreClaimEnabled = await ore.methods.minters(cartelOreClaimAddress).call();
          } catch (error) {
            console.log('Minter is not enabled');
          }

          const tokenIds = await cartelOreClaim.methods.unclaimedTokenIds('0x9c843b498321567072f57A890E6cA81c0cB6C2c2').call();
          console.log(tokenIds);
          const orePerToken = 100;
          const orePerSet = 300;
          const setCounter = [0, 0, 0, 0, 0, 0, 0];
          let tokenCount = 0;
          let totalSetClaim = 0;
          let totalTokenClaim = 0;
          tokenIds.forEach((tokenId) => {
            tokenCount++;
            let memberType;
            let groupId = Math.floor(tokenId / 100000);
            let memberId = tokenId % 100000;
            let num;

            if (groupId == 1000) {
              num = memberId - 1;
            } else if (groupId == 1002) {
              num = memberId + 1255;
            }

            if (num % 9 == 0) {
              memberType = num % 5;
            } else if (num % 10 == 0) {
              memberType = num % 6;
            } else {
              memberType = num % 7;
            }
            setCounter[memberType]++;
          });

          let totalOre = 0;
          if (tokenCount > 0) {
            totalTokenClaim += tokenCount;
            totalOre += tokenCount * orePerToken;
          }

          let setCount = tokenCount;
          for (let i = 0; i < 7; i++) {
            if (setCount > setCounter[i]) {
              setCount = setCounter[i];
            }
          }

          if (setCount > 0) {
            totalSetClaim += setCount;
            totalOre += setCount * orePerSet;
          }

          console.log(totalOre);

          const oreAmount = await ore.methods.balanceOf(accounts[0]).call();
          console.log(oreAmount);
          // await cartelOreClaim.methods.claim(tokenIds).send({ from: accounts[0] });

          if (!cartelOreClaimEnabled) {
            $('#currentCartelClaimState').html("False");
            $("#enableCartelClaim").val('Enable Cartel Ore Claim');

            $("#cartelOreClaimStateForm").submit(async function (event) {
              event.preventDefault();

              try {
                accounts = await web3.eth.getAccounts();
                await ore.methods.setMinter(cartelOreClaimAddress, true).send({ from: accounts[0] });
              } catch (error) {
                console.log('Failed to set minter');
              }
            });
          } else {
            $('#currentCartelClaimState').html("True");
            $("#enableCartelClaim").hide();
          }
        }
      });
    </script>
  </head>
  <body>
    <span style="font-weight: bold;">Collection Contracts Setup</span>
    <br/><br/>
    <form id="cartelOreClaimStateForm">
      Cartel Ore Claimer Enabled:
      <label id="currentCartelClaimState">False</label>
      <br/><br/>
      <input id="enableCartelClaim" type="submit" value="Enable Cartel Ore Claim">
    </form>
    <br />
  </body>
</html>