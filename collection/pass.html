<html>
  <head>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.3.5/dist/web3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/async@3.2.1/dist/async.min.js"></script>
    <script src="contract.js"></script>
    <script src="shop.js"></script>

    <script>
      $(async function() {
        if (window.ethereum) {
          console.log('Metamask enabled');
          web3 = new Web3(window.ethereum);
          let accounts = await web3.eth.getAccounts();

          if (!accounts || accounts.length === 0) {
            window.ethereum.request({ method: 'eth_requestAccounts' });
          }

          window.ethereum.on('accountsChanged', function (accounts) {
            window.location.reload();
          });

          const mintPass = new web3.eth.Contract(mintPassAbi, mintPassAddress);
          const mintPassMinter = new web3.eth.Contract(mintPassMinterAbi, mintPassMinterAddress);

          let passMinterEnabled = false;
          try {
            passMinterEnabled = await mintPass.methods.minters(mintPassMinterAddress).call();
          } catch (error) {
            console.log('Minter is not enabled');
          }

          if (!passMinterEnabled) {
            $('#currentMinterState').html("False");
            $('#enableMinter').val('Enable Pass Shop');

            $('#minterStateForm').submit(async function (event) {
              event.preventDefault();

              try {
                accounts = await web3.eth.getAccounts();
                console.log(accounts);
                await mintPass.methods.setMinter(mintPassMinterAddress, true).send({ from: accounts[0] });
              } catch (error) {
                console.log(error);
              }
            });
          } else {
            $('#currentMinterState').html('True');
            $('#enableMinter').hide();
          }

          const passStates = new Array(6).fill(false);
          const passPrices = new Array(6).fill(0);
          await async.eachOf(
            new Array(6),
            async function (_, index) {
              try {
                const state = await mintPass.methods.passExists(passes[index].id).call();
                const price = await mintPassMinter.methods.passPrice(passes[index].id).call();
                passStates[index] = state;
                passPrices[index] = price;
              } catch (error) {
                console.log(`Pass #${passes[index].id} not yet set`);
              }
            }
          );

          const passDiv = document.getElementById('passList');
          $.each(new Array(6), function (index) {
            var idLabel = document.createElement("span");
            idLabel.innerHTML = `Pass ID: ${passes[index].id}`;
            passDiv.append(idLabel);

            var lineBreak1 = document.createElement("br");
            passDiv.append(lineBreak1);

            var discountLabel = document.createElement("span");
            discountLabel.innerHTML = `Discount: ${passes[index].discount}%`;
            passDiv.append(discountLabel);

            var lineBreak2 = document.createElement("br");
            passDiv.append(lineBreak2);

            var priceLabel = document.createElement("span");
            priceLabel.innerHTML = `Price: ${passes[index].price} ORE`;
            passDiv.append(priceLabel);
            
            var lineBreak3 = document.createElement("br");
            passDiv.append(lineBreak3);

            var registerButton = document.createElement("button");
            registerButton.innerHTML = "Register";
            registerButton.style.marginTop = 10;
            registerButton.style.marginRight = 20;
            registerButton.hidden = passStates[index];
            registerButton.onclick = async function () {
              try {
                accounts = await web3.eth.getAccounts();
                await mintPass.methods.registerPass(passes[index].id, passes[index].discount, passes[index].baseTokenURI).send({ from: accounts[0] });
              } catch (error) {
                console.log(error);
              }
            };
            passDiv.append(registerButton);

            var setPriceButton = document.createElement("button");
            setPriceButton.innerHTML = "Set Price";
            setPriceButton.style.marginTop = 10;
            setPriceButton.hidden = (`${web3.utils.fromWei(`${passPrices[index]}`)}` === `${passes[index].price}`);
            setPriceButton.onclick = async function () {
              try {
                accounts = await web3.eth.getAccounts();
                await mintPassMinter.methods.setPassPrice(passes[index].id, web3.utils.toWei(`${passes[index].price}`)).send({ from: accounts[0] });
              } catch (error) {
                console.log(error);
              }
            };
            passDiv.append(setPriceButton);

            var lineBreak4 = document.createElement("br");
            passDiv.append(lineBreak4);

            var lineBreak5 = document.createElement("br");
            passDiv.append(lineBreak5);
          });

          $('#mintPassForMarketing').click(async function (event) {
            try {
              const passId = parseInt($("#passSelect").val());
              const amount = parseInt($("#amountSelect").val());
              accounts = await web3.eth.getAccounts();
              await mintPassMinter.methods.generatePassForMarketing(passId, amount).send({ from: accounts[0] });
            } catch (error) {
              console.log(error);
            }
          });
        }
      });
    </script>
  </head>
  <body>
    <span style="font-weight: bold;">Mint Pass Setup</span>
    <br/><br/>
    <form id="minterStateForm">
      Pass Shop Enabled For Minting Pass:
      <label id="currentMinterState">False</label>
      <br/><br/>
      <input id="enableMinter" type="submit" value="Enable Pass Shop" />
    </form>
    <hr/>
    <br/>
    <div id="passList">
    </div>
    <hr/>
    <br/>
    <div>
      Mint For Marketing <br/><br/>
      Pass Discount &nbsp;
      <select id="passSelect">
        <option value="1">0%</option>
        <option value="2">20%</option>
        <option value="3">25%</option>
        <option value="4">30#</option>
        <option value="5">35%</option>
        <option value="6">100%</option>
      </select>
      <br/><br/>
      Amount &nbsp;
      <select id="amountSelect">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
      </select>
      <br/><br/>
      <button id="mintPassForMarketing">Mint</button>
    </div>
    <br />
  </body>
</html>